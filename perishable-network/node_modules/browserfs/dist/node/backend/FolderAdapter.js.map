{"version":3,"file":"FolderAdapter.js","sourceRoot":"","sources":["../../../src/backend/FolderAdapter.ts"],"names":[],"mappings":";;;;;AAAA,4BAAyC,qBAAqB,CAAC,CAAA;AAC/D,IAAY,IAAI,WAAM,MAAM,CAAC,CAAA;AAC7B,0BAAuB,mBAAmB,CAAC,CAAA;AAE3C;;GAEG;AACH;IAA2C,iCAAc;IAOvD,uBAAY,MAAc,EAAE,OAAmB;QAC7C,iBAAO,CAAC;QACR,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC;QACtB,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;IAC1B,CAAC;IAVa,yBAAW,GAAzB;QACE,MAAM,CAAC,IAAI,CAAC;IACd,CAAC;IAUD;;;OAGG;IACI,kCAAU,GAAjB,UAAkB,EAA0B;QAA5C,iBAUC;QATC,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,UAAC,MAAe;YACjD,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC;gBACX,EAAE,EAAE,CAAC;YACP,CAAC;YAAC,IAAI,CAAC,EAAE,CAAC,CAAC,KAAI,CAAC,QAAQ,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;gBACtC,EAAE,CAAC,oBAAQ,CAAC,MAAM,CAAC,KAAI,CAAC,OAAO,CAAC,CAAC,CAAC;YACpC,CAAC;YAAC,IAAI,CAAC,CAAC;gBACN,KAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,KAAI,CAAC,OAAO,EAAE,KAAK,EAAE,EAAE,CAAC,CAAC;YAC/C,CAAC;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IAEM,+BAAO,GAAd,cAA2B,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;IACrD,kCAAU,GAAjB,cAA+B,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;IAC5D,qCAAa,GAApB,cAAkC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,aAAa,EAAE,CAAC,CAAC,CAAC;IAClE,qCAAa,GAApB,cAAkC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,aAAa,EAAE,CAAC,CAAC,CAAC;IAClE,qCAAa,GAApB,cAAkC,MAAM,CAAC,KAAK,CAAC,CAAC,CAAC;IACnD,oBAAC;AAAD,CAAC,AAlCD,CAA2C,4BAAc,GAkCxD;AAlCD;kCAkCC,CAAA;AAED,wBAAwB,MAAc,EAAE,CAAM;IAC5C,EAAE,CAAC,CAAC,CAAC,KAAK,IAAI,IAAI,OAAO,CAAC,KAAK,QAAQ,CAAC,CAAC,CAAC;QACxC,IAAI,GAAG,GAAc,CAAC,CAAC;QACvB,IAAI,CAAC,GAAG,GAAG,CAAC,IAAI,CAAC;QACjB,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YACN,CAAC,GAAG,GAAG,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC;YACnC,GAAG,CAAC,OAAO,GAAG,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;YAC/C,GAAG,CAAC,IAAI,GAAG,CAAC,CAAC;QACf,CAAC;IACH,CAAC;IACD,MAAM,CAAC,CAAC,CAAC;AACX,CAAC;AAED,sBAAsB,MAAc,EAAE,EAAO;IAC3C,EAAE,CAAC,CAAC,OAAO,EAAE,KAAK,UAAU,CAAC,CAAC,CAAC;QAC7B,MAAM,CAAC,UAAS,GAAa;YAC3B,EAAE,CAAC,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;gBACzB,SAAS,CAAC,CAAC,CAAC,GAAG,cAAc,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;YAC7C,CAAC;YACW,EAAG,CAAC,KAAK,CAAC,IAAI,EAAE,SAAS,CAAC,CAAC;QACzC,CAAC,CAAC;IACJ,CAAC;IAAC,IAAI,CAAC,CAAC;QACN,MAAM,CAAC,EAAE,CAAC;IACZ,CAAC;AACH,CAAC;AAED,sBAAsB,IAAY,EAAE,SAAkB,EAAE,UAAmB;IACzE,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,GAAG,CAAC,CAAC,KAAK,MAAM,CAAC,CAAC,CAAC;QAC3C,+CAA+C;QAC/C,MAAM,CAAC;YACL,EAAE,CAAC,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;gBACzB,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;oBACd,SAAS,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;gBACvD,CAAC;gBACD,EAAE,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;oBACf,SAAS,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;gBACvD,CAAC;gBACD,SAAS,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC,GAAG,YAAY,CAAC,IAAI,CAAC,OAAO,EAAE,SAAS,CAAC,SAAS,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;YAChG,CAAC;YACD,MAAM,CAAQ,IAAI,CAAC,QAAS,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,EAAE,SAAS,CAAC,CAAC;QACrE,CAAC,CAAC;IACJ,CAAC;IAAC,IAAI,CAAC,CAAC;QACN,2CAA2C;QAC3C,MAAM,CAAC;YACL,IAAI,CAAC;gBACH,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC;oBACd,SAAS,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;gBACvD,CAAC;gBACD,EAAE,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC;oBACf,SAAS,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;gBACvD,CAAC;gBACD,MAAM,CAAQ,IAAI,CAAC,QAAS,CAAC,IAAI,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,QAAQ,EAAE,SAAS,CAAC,CAAC;YACrE,CAAE;YAAA,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;gBACX,MAAM,cAAc,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC,CAAC;YACxC,CAAC;QACH,CAAC,CAAC;IACJ,CAAC;AACH,CAAC;AAED,4BAA4B;AAC5B,CAAC,WAAW,EAAE,MAAM,EAAE,UAAU,EAAE,MAAM,EAAE,UAAU,EAAE,QAAQ,EAAE,YAAY;IAC3E,OAAO,EAAE,WAAW,EAAE,OAAO,EAAE,WAAW,EAAE,SAAS,EAAE,aAAa,EAAE,QAAQ;IAC9E,YAAY,EAAE,UAAU,EAAE,cAAc,EAAE,UAAU,EAAE,cAAc,EAAE,UAAU;IAChF,cAAc,EAAE,WAAW,EAAE,eAAe,EAAE,YAAY,EAAE,gBAAgB;IAC5E,OAAO,EAAE,WAAW,EAAE,OAAO,EAAE,WAAW,EAAE,QAAQ,EAAE,YAAY,EAAE,UAAU;IAC9E,cAAc,CAAC,CAAC,OAAO,CAAC,UAAC,IAAY;IAC7B,aAAa,CAAC,SAAU,CAAC,IAAI,CAAC,GAAG,YAAY,CAAC,IAAI,EAAE,IAAI,EAAE,KAAK,CAAC,CAAC;AAC1E,CAAC,CAAC,CAAC;AAEH,wCAAwC;AACxC,CAAC,QAAQ,EAAE,YAAY,EAAE,MAAM,EAAE,UAAU,EAAE,SAAS,EAAE,aAAa,CAAC,CAAC,OAAO,CAAC,UAAC,IAAY;IACnF,aAAa,CAAC,SAAU,CAAC,IAAI,CAAC,GAAG,YAAY,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;AACzE,CAAC,CAAC,CAAC","sourcesContent":["import {BaseFileSystem, FileSystem} from '../core/file_system';\nimport * as path from 'path';\nimport {ApiError} from '../core/api_error';\n\n/**\n * The FolderAdapter file system wraps a file system, and scopes all interactions to a subfolder of that file system.\n */\nexport default class FolderAdapter extends BaseFileSystem implements FileSystem {\n  public static isAvailable(): boolean {\n    return true;\n  }\n\n  public _wrapped: FileSystem;\n  public _folder: string;\n  constructor(folder: string, wrapped: FileSystem) {\n    super();\n    this._folder = folder;\n    this._wrapped = wrapped;\n  }\n\n  /**\n   * Initialize the file system. Ensures that the wrapped file system\n   * has the given folder.\n   */\n  public initialize(cb: (e?: ApiError) => void) {\n    this._wrapped.exists(this._folder, (exists: boolean) => {\n      if (exists) {\n        cb();\n      } else if (this._wrapped.isReadOnly()) {\n        cb(ApiError.ENOENT(this._folder));\n      } else {\n        this._wrapped.mkdir(this._folder, 0x1ff, cb);\n      }\n    });\n  }\n\n  public getName(): string { return this._wrapped.getName(); }\n  public isReadOnly(): boolean { return this._wrapped.isReadOnly(); }\n  public supportsProps(): boolean { return this._wrapped.supportsProps(); }\n  public supportsSynch(): boolean { return this._wrapped.supportsSynch(); }\n  public supportsLinks(): boolean { return false; }\n}\n\nfunction translateError(folder: string, e: any): any {\n  if (e !== null && typeof e === 'object') {\n    let err = <ApiError> e;\n    let p = err.path;\n    if (p) {\n      p = '/' + path.relative(folder, p);\n      err.message = err.message.replace(err.path, p);\n      err.path = p;\n    }\n  }\n  return e;\n}\n\nfunction wrapCallback(folder: string, cb: any): any {\n  if (typeof cb === 'function') {\n    return function(err: ApiError) {\n      if (arguments.length > 0) {\n        arguments[0] = translateError(folder, err);\n      }\n      (<Function> cb).apply(null, arguments);\n    };\n  } else {\n    return cb;\n  }\n}\n\nfunction wrapFunction(name: string, wrapFirst: boolean, wrapSecond: boolean): Function {\n  if (name.slice(name.length - 4) !== 'Sync') {\n    // Async function. Translate error in callback.\n    return function(this: FolderAdapter) {\n      if (arguments.length > 0) {\n        if (wrapFirst) {\n          arguments[0] = path.join(this._folder, arguments[0]);\n        }\n        if (wrapSecond) {\n          arguments[1] = path.join(this._folder, arguments[1]);\n        }\n        arguments[arguments.length - 1] = wrapCallback(this._folder, arguments[arguments.length - 1]);\n      }\n      return (<any> this._wrapped)[name].apply(this._wrapped, arguments);\n    };\n  } else {\n    // Sync function. Translate error in catch.\n    return function(this: FolderAdapter) {\n      try {\n        if (wrapFirst) {\n          arguments[0] = path.join(this._folder, arguments[0]);\n        }\n        if (wrapSecond) {\n          arguments[1] = path.join(this._folder, arguments[1]);\n        }\n        return (<any> this._wrapped)[name].apply(this._wrapped, arguments);\n      } catch (e) {\n        throw translateError(this._folder, e);\n      }\n    };\n  }\n}\n\n// First argument is a path.\n['diskSpace', 'stat', 'statSync', 'open', 'openSync', 'unlink', 'unlinkSync',\n 'rmdir', 'rmdirSync', 'mkdir', 'mkdirSync', 'readdir', 'readdirSync', 'exists',\n 'existsSync', 'realpath', 'realpathSync', 'truncate', 'truncateSync', 'readFile',\n 'readFileSync', 'writeFile', 'writeFileSync', 'appendFile', 'appendFileSync',\n 'chmod', 'chmodSync', 'chown', 'chownSync', 'utimes', 'utimesSync', 'readlink',\n 'readlinkSync'].forEach((name: string) => {\n  (<any> FolderAdapter.prototype)[name] = wrapFunction(name, true, false);\n});\n\n// First and second arguments are paths.\n['rename', 'renameSync', 'link', 'linkSync', 'symlink', 'symlinkSync'].forEach((name: string) => {\n  (<any> FolderAdapter.prototype)[name] = wrapFunction(name, true, true);\n});\n"]}